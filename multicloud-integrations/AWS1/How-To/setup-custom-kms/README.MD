# Protect Data Using AWS KMS - Customer-Provided Encryption Keys (SSE-C)

Server-side encryption(SSE) is about protecting data at rest. AWS allows to protect data at rest within Amazon data centers by using AWS KMS. Using server-side encryption with customer-provided encryption keys (SSE-C) allows you to set your own encryption keys.

Follow this article in [Youtube](https://youtu.be/VIWMezx8XiQ)

![AWS-Custom-Key](https://raw.githubusercontent.com/miztiik/AWS-Demos/master/How-To/setup-custom-kms/images/AWS-Custom-KMS.png)

_**Note**: AWS KMS SSE-C are region specific. If you create a custom encryption key in `us-east-1` i.e Virginia, then that key will be available only in `us-east-1` - Virginia Region only._

### How to `Bring Your Own Keys` into AWS KMS
For production use cases, the key will be generated by HSM or you will be using a key with more 2048 bits.
For this demo, We will use 256-Bit AES Symmetric key. If you dont have one, follow the below instructions to generate one.

####  Generate the `Secret` Key
We wil be using `openssl` to generate a 256-bit symmetric key. You can also use `dd` command. Now we have a binary key stored in the file `plain_text_aes_key.bin`
```sh
openssl rand -out plain_text_aes_key.bin 32
or
dd if=/dev/random of=plain_text_aes_key.bin count=1 bs=32
```

### AWS KMS GUI
Now that we have our `Secret` Key, We need to create an entity in KMS to receive our key material.
1. **Create key** in the KMS Console
1. Enter an **Alias** and a **Description**
1. Select **External**
1. **Check** - The "I understand…" checkbox
1. Choose the set of IAM users that have permission to `Use the KMS APIs` and,
1. Choose the set of IAM users who can `Administer the key`
1. **Verify** the key policy
1. **Download** the `wrapping key`, Choose **RSAES_OAEP_SHA_1**
   - The `wrapping key` is the 2048-bit RSA public key from your AWS account, that will be used to encrypt the 256-bit secret key
    and import to into KMS.
   - _This additional step ensure, anyone snooping on my network will not be able to get hold of my secret key._

#### Wrap the `Secret` Key with `wrappingKey`
UnZIP and put the wrapping key into the same directory that contains your `Secret` Key.
```sh
openssl rsautl -encrypt \
               -in plain_text_aes_key.bin \
               -oaep \
               -inkey wrappingKey_521a8b4c-8463-4ccd-a762-7bcf6a9b2cfc_1227021858 \
               -pubin \
               -keyform DER \
               -out enc.aes.key
```

### Import Key material into KMS
Choose **I am ready to upload…** & click **Next**. Upload the encrypted key `enc.aes.key` and choose the expiry date as needed.  Clicked on **Finish** and the key is _Enabled_ and ready for me to use.

![Custom-Key-Import-To-KMS-SSE-C](https://raw.githubusercontent.com/miztiik/AWS-Demos/master/How-To/setup-custom-kms/images/kms_spec_key_materials_1.png)

### Encrypt with Custom SSE-C in S3
Now you are ready to use your custom Key. Upload an `Object` to any bucket in the region you created the `key` and under encryption you should be able to use the new key.

