{
  "schemaVersion": "2.2",
  "description": "Install Anti-Virus Malware",
  "mainSteps": [
    {
      "action": "aws:runPowerShellScript",
      "name": "InstallAntiMalwareInWindows",
      "inputs": {
        "runCommand": [
          "if (-NOT ([Security.Principal.WindowsPrincipal] [Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole] 'Administrator')) {",
          "Write-Warning 'You are not running as an Administrator. Please try again with admin privileges.'",
          "exit 1",
          "}",
          "",
          "$appLogPath='\\TrendMicro\\DeepSecurityAgent\\installer'",
          "$env:LogPath = $env:appdata+$appLogPath",
          "New-Item -path $env:LogPath -type directory",
          "Start-Transcript -path $env:LogPath\\dsa_deploy.log -append",
          "",
          "",
          "$baseUrl='https://app.deepsecurity.trendmicro.com:443/'",
          "",
          "if ( [intptr]::Size -eq 8 ) { ",
          "$sourceUrl=-join($baseurl, 'software/agent/Windows/x86_64/') }",
          "else {",
          "$sourceUrl=-join($baseurl, 'software/agent/Windows/i386/') }",
          "echo 'Download Deep Security Agent Package'",
          "",
          "$WebClient = New-Object System.Net.WebClient",
          "",
          "[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12;",
          "[Net.ServicePointManager]::ServerCertificateValidationCallback = {$true}",
          "",
          "$tmpExeFile='\\agent.msi'",
          "$tmpExeFileLoc=$env:temp+$tmpExeFile",
          "",
          "$WebClient.DownloadFile($sourceUrl,  $tmpExeFileLoc)",
          "",
          "",
          "",
          "if ( (Get-Item $tmpExeFileLoc).length -eq 0 ) {",
          "",
          "echo 'Failed to download the Deep Security Agent. Please check if the package is imported into the Deep Security Manager.'",
          "",
          "exit 1",
          "",
          "}",
          "",
          "",
          "echo 'DSA install started'",
          "$arg0 = '/i ' + $tmpExeFileLoc",
          "$arg1 = $arg0 + ' /qn ADDLOCAL=ALL '",
          "$MSIArguments = $arg1 + ' /l*v ' + $env:LogPath + '\\dsa_install.log'",
          "Start-Process -FilePath msiexec $MSIArguments -Wait -PassThru",
          "echo 'DSA activation started'",
          "",
          "$appPath=''",
          "",
          "Start-Sleep -s 50",
          "$appPath='\\Trend Micro\\Deep Security Agent\\dsa_control'",
          "& $Env:ProgramFiles$appPath -r",
          "",
          "& $Env:ProgramFiles$appPath -a dsm://agents.deepsecurity.trendmicro.com:443/ 'tenantID:B4A289AC-4BA5-EC0C-8E56-5DEF230700AF' 'token:2E276B01-C7A2-2414-8CA1-CB182F0B3F10' 'policyid:@'",
          "Stop-Transcript",
          "echo 'DSA Deployment Finished'"
        ]
      }
    }
  ]
}